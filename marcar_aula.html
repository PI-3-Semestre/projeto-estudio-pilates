<!DOCTYPE html>

<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Criar Nova Aula</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0fbdab",
                        "background-light": "#f6f8f8",
                        "background-dark": "#102220",
                        "text-light": "#1A202C",
                        "text-dark": "#f6f8f8",
                        "border-light": "#CBD5E0",
                        "border-dark": "#4A5568",
                        "placeholder-light": "#A0AEC0",
                        "placeholder-dark": "#718096"
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .form-input {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.5em;
        }

        select.form-input {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex min-h-screen w-full flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-10 flex items-center bg-background-light dark:bg-background-dark p-4 shadow-sm">
            <button class="flex h-10 w-10 shrink-0 items-center justify-center text-text-light dark:text-text-dark">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1
                class="flex-1 text-center text-lg font-bold leading-tight tracking-tight text-text-light dark:text-text-dark">
                Criar Nova Aula</h1>
            <div class="h-10 w-10 shrink-0"></div> <!-- Spacer to center title -->
        </header>
        <!-- Form Body (Scrollable) -->
        <main class="flex-1 overflow-y-auto px-4 pb-28 pt-4">
            <div class="mx-auto max-w-lg space-y-6">
                <!-- Modalidade -->
                <div class="flex flex-col">
                    <label class="pb-2 text-base font-medium leading-normal text-text-light dark:text-text-dark"
                        for="modalidade">Modalidade</label>
                    <div class="relative">
                        <select
                            class="form-input h-14 w-full rounded-lg border border-border-light bg-white p-4 text-base font-normal text-text-light placeholder:text-placeholder-light focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder:text-placeholder-dark"
                            id="modalidade">
                            <option disabled="" selected="" value="">Selecione a modalidade</option>
                            <option value="yoga">Yoga</option>
                            <option value="pilates">Pilates</option>
                            <option value="crossfit">Crossfit</option>
                        </select>
                    </div>
                </div>
                <!-- Instrutor Principal -->
                <div class="flex flex-col">
                    <label class="pb-2 text-base font-medium leading-normal text-text-light dark:text-text-dark"
                        for="instrutor_principal">Instrutor Principal</label>
                    <div class="relative">
                        <select
                            class="form-input h-14 w-full rounded-lg border border-border-light bg-white p-4 text-base font-normal text-text-light placeholder:text-placeholder-light focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder:text-placeholder-dark"
                            id="instrutor_principal">
                            <option disabled="" selected="" value="">Carregando instrutores...</option>
                        </select>
                    </div>
                </div>
                <!-- Instrutor Substituto -->
                <div class="flex flex-col">
                    <label class="pb-2 text-base font-medium leading-normal text-text-light dark:text-text-dark"
                        for="instrutor_substituto">Instrutor Substituto (Opcional)</label>
                    <div class="relative">
                        <select
                            class="form-input h-14 w-full rounded-lg border border-border-light bg-white p-4 text-base font-normal text-text-light placeholder:text-placeholder-light focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder:text-placeholder-dark"
                            id="instrutor_substituto">
                            <option disabled="" selected="" value="">Carregando instrutores...</option>
                        </select>
                    </div>
                </div>
                <!-- Capacidade -->
                <div class="flex flex-col">
                    <label class="pb-2 text-base font-medium leading-normal text-text-light dark:text-text-dark"
                        for="capacidade">Capacidade</label>
                    <input
                        class="h-14 w-full rounded-lg border border-border-light bg-white p-4 text-base font-normal text-text-light placeholder:text-placeholder-light focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder:text-placeholder-dark"
                        id="capacidade" placeholder="Ex: 15" type="number" value="" />
                </div>
                <!-- Date and Time Picker -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Data -->
                    <div class="flex flex-col">
                        <label class="pb-2 text-base font-medium leading-normal text-text-light dark:text-text-dark"
                            for="data">Data</label>
                        <div class="relative">
                            <input
                                class="form-input h-14 w-full rounded-lg border border-border-light bg-white p-4 text-base font-normal text-text-light placeholder:text-placeholder-light focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder:text-placeholder-dark dark:[color-scheme:dark]"
                                id="data" placeholder="Selecione a data" type="date" />
                        </div>
                    </div>
                    <!-- Horário -->
                    <div class="flex flex-col">
                        <label class="pb-2 text-base font-medium leading-normal text-text-light dark:text-text-dark"
                            for="horario">Horário</label>
                        <div class="relative">
                            <input
                                class="form-input h-14 w-full rounded-lg border border-border-light bg-white p-4 text-base font-normal text-text-light placeholder:text-placeholder-light focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 dark:border-border-dark dark:bg-background-dark dark:text-text-dark dark:placeholder:text-placeholder-dark dark:[color-scheme:dark]"
                                id="horario" placeholder="Selecione o horário" type="time" />
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!-- Fixed Footer -->
        <footer class="fixed bottom-0 left-0 right-0 z-10 bg-background-light p-4 dark:bg-background-dark">
            <div class="mx-auto max-w-lg">
                <button
                    class="w-full rounded-xl bg-primary px-6 py-4 text-lg font-bold text-white transition-colors hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-background-dark">
                    Salvar Aula
                </button>
            </div>
        </footer>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Iniciando script para carregar instrutores...");

            const principalSelect = document.getElementById('instrutor_principal');
            const substitutoSelect = document.getElementById('instrutor_substituto');
            const selects = [principalSelect, substitutoSelect];

            const setSelectsMessage = (message) => {
                selects.forEach(select => {
                    if (select) {
                        select.innerHTML = `<option value="" disabled selected>${message}</option>`;
                    }
                });
            };

            const authData = localStorage.getItem('auth');
            if (!authData) {
                setSelectsMessage('Não autenticado');
                console.error('Dados de autenticação não encontrados no localStorage.');
                return;
            }

            let token;
            try {
                token = JSON.parse(authData)?.access;
                if (!token) {
                    throw new Error("Token de acesso não encontrado nos dados de autenticação.");
                }
                console.log("Token de acesso encontrado.");
            } catch (e) {
                setSelectsMessage('Erro de autenticação');
                console.error('Falha ao parsear dados de autenticação ou token ausente:', e);
                return;
            }

            try {
                // Etapa 1: Obter o ID do perfil 'INSTRUTOR'
                console.log("Buscando perfis da API...");
                const perfisResponse = await fetch('http://127.0.0.1:8000/api/perfis/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!perfisResponse.ok) {
                    throw new Error(`Erro ao buscar perfis! Status: ${perfisResponse.status}`);
                }

                const perfis = await perfisResponse.json();
                console.log("Perfis recebidos:", perfis);

                const perfilInstrutor = perfis.find(p => p.nome === 'INSTRUTOR');
                if (!perfilInstrutor) {
                    throw new Error("Perfil 'INSTRUTOR' não encontrado na API de perfis.");
                }
                const idPerfilInstrutor = perfilInstrutor.id;
                console.log(`ID do perfil 'INSTRUTOR' encontrado: ${idPerfilInstrutor}`);

                // Etapa 2: Obter e filtrar os colaboradores
                console.log("Buscando colaboradores da API...");
                const colaboradoresResponse = await fetch('http://127.0.0.1:8000/api/colaboradores/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!colaboradoresResponse.ok) {
                    throw new Error(`Erro ao buscar colaboradores! Status: ${colaboradoresResponse.status}`);
                }

                const todosColaboradores = await colaboradoresResponse.json();
                console.log("Colaboradores recebidos:", todosColaboradores);

                const instrutores = todosColaboradores.filter(colaborador =>
                    colaborador.perfis.includes(idPerfilInstrutor)
                );
                console.log("Instrutores filtrados:", instrutores);

                selects.forEach(select => select && (select.innerHTML = '')); // Limpa "Carregando..."

                if (instrutores.length === 0) {
                    setSelectsMessage('Nenhum instrutor encontrado');
                    console.warn("A API retornou colaboradores, mas nenhum com o perfil 'INSTRUTOR'.");
                    return;
                }

                // Popula Instrutor Principal
                const defaultOptionPrincipal = document.createElement('option');
                defaultOptionPrincipal.value = "";
                defaultOptionPrincipal.textContent = "Selecione o instrutor principal";
                defaultOptionPrincipal.disabled = true;
                defaultOptionPrincipal.selected = true;
                principalSelect.appendChild(defaultOptionPrincipal);

                // Popula Instrutor Substituto
                const defaultOptionSubstituto = document.createElement('option');
                defaultOptionSubstituto.value = ""; // Valor vazio para opcional
                defaultOptionSubstituto.textContent = "Nenhum (opcional)";
                defaultOptionSubstituto.selected = true;
                substitutoSelect.appendChild(defaultOptionSubstituto);

                instrutores.forEach(instrutor => {
                    const option = document.createElement('option');
                    // De acordo com a nova API, 'usuario' é o ID e 'nome_completo' é o nome.
                    option.value = instrutor.usuario; 
                    option.textContent = instrutor.nome_completo;
                    
                    principalSelect.appendChild(option.cloneNode(true));
                    substitutoSelect.appendChild(option.cloneNode(true));
                });

                console.log("Dropdowns de instrutores populados com sucesso.");

            } catch (error) {
                console.error('Falha ao buscar ou processar instrutores:', error);
                setSelectsMessage('Erro ao carregar instrutores');
            }
        });
    </script>
</body>

</html>